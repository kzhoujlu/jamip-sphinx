<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4. 高通量计算流程 &mdash; JAMIP 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=f2a433a1"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            JAMIP
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">4. 高通量计算流程</a><ul>
<li><a class="reference internal" href="#id2">4.1 任务流程简介</a><ul>
<li><a class="reference internal" href="#id3">4.1.1 参数设置</a><ul>
<li><a class="reference internal" href="#id4">第一性原理计算参数</a><ul>
<li><a class="reference internal" href="#id5">任务控制文件中的通用设置</a></li>
<li><a class="reference internal" href="#input-py">任务控制文件（input.py）中，用于文件准备的相关函数</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">集群管理参数</a><ul>
<li><a class="reference internal" href="#id7">通用设置参数</a></li>
<li><a class="reference internal" href="#id8">作业提交模板</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id9">4.1.2 任务池管理与批量提交</a><ul>
<li><a class="reference internal" href="#id10">任务池文件说明</a></li>
<li><a class="reference internal" href="#id11">再次提交</a></li>
<li><a class="reference internal" href="#id12">多任务池与排队机制</a></li>
<li><a class="reference internal" href="#id13">子任务池</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id14">4.1.3 任务执行流程</a></li>
<li><a class="reference internal" href="#id15">4.1.4 任务监控与纠错</a><ul>
<li><a class="reference internal" href="#id16">监控模块</a></li>
<li><a class="reference internal" href="#id17">集群检查</a></li>
<li><a class="reference internal" href="#id18">纠错计算和纠错集设置</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id19">4.1.5 计算结果提取与分析</a></li>
<li><a class="reference internal" href="#id20">4.1.6 计算结果存储</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">JAMIP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">4. 高通量计算流程</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/zh_part_4.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>4. 高通量计算流程<a class="headerlink" href="#id1" title="Link to this heading"></a></h1>
<p>本章将介绍JAMIP如何实现高通量计算任务的创建和流程管理。通过本章节的阅读，您可以了解以下内容：</p>
<ul class="simple">
<li><p>高通量计算的任务流程与参数设置</p></li>
<li><p>计算任务的流程细节</p></li>
</ul>
<section id="id2">
<h2>4.1 任务流程简介<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<p>任务( task )是JAMIP进行DFT计算的基本单元，每个任务对应特定的计算需求，通过一次或多次计算实现。下面将简单介绍JAMIP目前已经实现的计算任务流程。</p>
<section id="id3">
<h3>4.1.1 参数设置<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>JAMIP的运行配置文件包含以下四个文件，用户可以通过修改提交目录下的这些文件，动态地设置本次计算的参数：</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>filename</th>
<th>function</th>
</tr>
</thead>
<tbody>
<tr>
<td>input.py</td>
<td>任务控制文件</td>
</tr>
<tr>
<td>.incar</td>
<td>计算参数文件</td>
</tr>
<tr>
<td>.cluster</td>
<td>集群参数文件</td>
</tr>
<tr>
<td>.link</td>
<td>任务依赖参数文件</td>
</tr>
<tr>
<td>.extra</td>
<td>结构参数文件</td>
</tr>
</tbody>
</table><p>其中<code class="docutils literal notranslate"><span class="pre">input.py</span></code>可通过<code class="docutils literal notranslate"><span class="pre">jp</span> <span class="pre">-i</span> <span class="pre">[software]</span></code>命令生成模板，如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jp</span> <span class="o">-</span><span class="n">i</span> <span class="n">vasp</span> <span class="c1"># 用于VASP计算任务的提交</span>
<span class="n">jp</span> <span class="o">-</span><span class="n">i</span> <span class="n">qe</span> <span class="c1"># 用于Quantum Espresso计算任务的提交</span>
</pre></div>
</div>
<p>其他文件将在用户第一次执行 jp -r prepare 后，生成模板。</p>
<section id="id4">
<h4>第一性原理计算参数<a class="headerlink" href="#id4" title="Link to this heading"></a></h4>
<section id="id5">
<h5>任务控制文件中的通用设置<a class="headerlink" href="#id5" title="Link to this heading"></a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span><span class="w"> </span><span class="n">program</span><span class="w"> </span>
<span class="w"> </span><span class="n">使用程序的路径</span><span class="err">，</span><span class="n">如</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">vasp</span><span class="o">/</span><span class="n">vasp5</span><span class="mf">.4.1</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">vasp_std</span><span class="err">&#39;</span>
<span class="w"> </span><span class="cp"># 如果用户使用vasp计算，希望在计算中切换vasp程序，可以设置：</span>
<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="n">std</span><span class="err">&#39;</span><span class="o">:</span><span class="w"> </span><span class="err">&#39;</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">vasp6</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">vasp_std</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">                   </span><span class="err">&#39;</span><span class="n">ncl</span><span class="err">&#39;</span><span class="o">:</span><span class="w"> </span><span class="err">&#39;</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">vasp6</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">vasp_ncl</span><span class="err">&#39;</span><span class="p">}</span>
<span class="w"> </span><span class="cp"># 对于类似于QE，计算中涉及多种可执行程序的软件，输入bin即可：</span>
<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">qe</span><span class="p">.</span><span class="n">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">qe</span><span class="mf">-6.6</span><span class="o">/</span><span class="n">bin</span><span class="err">&#39;</span>
<span class="w"> </span>
<span class="mf">2.</span><span class="w"> </span><span class="n">potential</span><span class="w"> </span>
<span class="w"> </span><span class="n">赝势库目录</span><span class="err">，</span><span class="n">如</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">potential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">vasp</span><span class="o">/</span><span class="n">paw_pbe</span><span class="err">&#39;</span>
<span class="w"> </span><span class="cp"># 赝势库的形式与不同软件所采用的命名规则有关，如vasp的赝势库是以元素命名的文件夹，</span>
<span class="w"> </span><span class="cp"># QE则直接是全部赝势文件，通过文件命名确定元素和赝势类型</span>
<span class="w"> </span><span class="cp"># 针对VASP赝势库中，一种元素对应多种赝势的情况，如果用户希望选用元素的指定赝势，可以在路径后添加映射字典，如：</span>
<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">potential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">vasp</span><span class="o">/</span><span class="n">paw</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="n">Si</span><span class="sc">&#39;:&#39;</span><span class="n">Si_d</span><span class="sc">&#39;,&#39;</span><span class="n">Mg</span><span class="sc">&#39;:&#39;</span><span class="n">Mg_pv</span><span class="err">&#39;</span><span class="p">}</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">tasks</span>
<span class="w"> </span><span class="n">计算任务</span><span class="err">，</span><span class="n">任务名之间使用空格分隔</span><span class="err">，</span><span class="n">例如</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">relax</span><span class="w"> </span><span class="n">scf</span><span class="w"> </span><span class="n">band</span><span class="w"> </span><span class="n">dos</span><span class="w"> </span><span class="n">optics</span><span class="err">&#39;</span>
<span class="w"> </span><span class="cp"># 关于当前软件支持的任务，请参阅：控制文件实例或继续阅读后续内容</span>
<span class="w"> </span>
<span class="mf">4.</span><span class="w"> </span><span class="n">xc_func</span>
<span class="w"> </span><span class="n">计算使用的参数集</span><span class="err">，</span><span class="n">包含交换关联泛函</span><span class="err">、</span><span class="n">soc</span><span class="err">、</span><span class="n">ldau等</span><span class="err">。</span><span class="n">默认情况下</span><span class="err">，</span><span class="n">VASP计算仅使用PBE泛函</span><span class="err">，</span><span class="n">设置如下</span><span class="err">：</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">xc_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">pbe</span><span class="err">&#39;</span>
<span class="w"> </span><span class="cp"># 如果用户希望同时使用多种参数集，需要使用空格连接，例如</span>
<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">xc_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">hse</span><span class="w"> </span><span class="n">soc</span><span class="w"> </span><span class="n">ldau</span><span class="err">&#39;</span>
<span class="w"> </span><span class="cp"># 如果用户输入soc, hse, gw，ldau等参数，JAMIP将自动在计算时中添加所需的特有计算参数</span>
<span class="w"> </span><span class="cp"># 注意：上述参数设置对全部计算生效，用户可以在.incar中修改参数集内容</span>
<span class="w"> </span>
<span class="mf">5.</span><span class="w"> </span><span class="n">magmom</span>
<span class="w"> </span><span class="n">计算时使用的磁矩字典</span><span class="err">，</span><span class="n">例如</span><span class="err">（</span><span class="n">以CsPbI3为例</span><span class="err">）</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">magmom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="n">Cs</span><span class="err">&#39;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="n">Pb</span><span class="err">&#39;</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;I&#39;</span><span class="o">:</span><span class="mi">0</span><span class="p">}</span>
<span class="w"> </span><span class="cp"># 此时INCAR将设置为 MAGMOM = 1*0 1*3 3*0 </span>
<span class="w"> </span><span class="cp"># 默认情况下，JAMIP设置vasp.magmom=False，即不在INCAR中输出MAGMOM</span>
<span class="w"> </span><span class="cp"># 此时计算将使用VASP的默认值，将所有元素磁矩设置为1，等价于 MAGMOM = 5*1</span>
<span class="w"> </span><span class="cp"># 如果结构中出现了磁矩字典中未包含的元素，这些元素的磁矩也将使用1</span>
<span class="w"> </span><span class="cp"># 以CsPbI3为例，如果设置 vasp.magmom=True 或 vasp.magmom = {&#39;Pb&#39;:3}</span>
<span class="w"> </span><span class="cp"># INCAR将分别显示 MAGMOM = 1*1 1*1 3*1 和 MAGMOM = 1*1 1*3 3*1</span>
<span class="w"> </span><span class="cp"># 注意：磁矩只能设置为整数值</span>
<span class="w"> </span>
<span class="mf">6.</span><span class="w"> </span><span class="n">vdw</span>
<span class="w"> </span><span class="n">计算使用的vdw泛函类型</span><span class="err">，</span><span class="n">例如</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">vdw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">d3</span><span class="err">&#39;</span>
<span class="w"> </span><span class="cp"># JAMIP支持的vdw泛函有: d2, d3, b86, b88, pbe, df2, revdf2, rvv10, revpbe, optpbe </span>
<span class="w"> </span><span class="cp"># 在使用部分vdw泛函时（例如b86,b88,rvv10等），需要用户提供额外的核文件（vdw_kernel.bindat），设置如下</span>
<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">vdw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">b86</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">/</span><span class="n">public</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">vasp</span><span class="o">/</span><span class="n">vdw_kernel</span><span class="p">.</span><span class="n">bindat</span><span class="err">&#39;</span>
<span class="w"> </span>
<span class="mf">7.</span><span class="w"> </span><span class="n">energy</span>
<span class="w"> </span><span class="n">设置能量的收敛值</span><span class="err">，</span><span class="n">例如</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">energy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-5</span>
<span class="w"> </span><span class="cp"># 在VASP程序中对应：EDIFF=1e-5，单位为：eV</span>
<span class="w"> </span><span class="cp"># 在QE程序中对应：etot_conv_thr，单位为：Ry</span>
<span class="w"> </span>
<span class="mf">8.</span><span class="w"> </span><span class="n">force</span>
<span class="w"> </span><span class="n">设置力的收敛值</span><span class="err">，</span><span class="n">例如</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">force</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-2</span>
<span class="w"> </span><span class="cp"># 在VASP程序中对应：EDIFFG=-1e-2，单位为：eV</span>
<span class="w"> </span><span class="cp"># 在QE程序中对应：forc_conv_thr，单位为：Ry</span>
<span class="w"> </span>
<span class="mf">9.</span><span class="w"> </span><span class="n">kpoints</span>
<span class="w"> </span><span class="n">设置计算使用的K点</span><span class="err">。</span><span class="n">k点支持多种设置方法</span><span class="err">，</span><span class="n">例如</span>
<span class="w"> </span><span class="cp"># 1. kspacing模式，根据倒空间大小进行插点，输入值为K点在倒空间中的间隔</span>
<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">kpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span>
<span class="w"> </span><span class="cp"># 2. Gamma模式或 Monkhorst模式，声明模式时提供首字母即可</span>
<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">kpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">Gamma</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">6</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">6</span><span class="err">&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">插点数</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="n">无偏移</span>
<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">kpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;M&#39;</span><span class="p">,</span><span class="err">&#39;</span><span class="mi">6</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="mf">0.5</span><span class="err">&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">插点数</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="n">偏移量</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span>
<span class="w"> </span><span class="cp"># 3. Line Model， 线性插点, 根据元组长度不同对应以下三种模式：</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">kpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">Line</span><span class="w"> </span><span class="n">Model</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="err">\</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="s">&quot;Line&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K点</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">插点数</span><span class="p">(</span><span class="n">可选</span><span class="err">，</span><span class="n">默认为30</span><span class="p">)</span>
<span class="w">                 </span><span class="s">&quot;0.0000 0.0000 0.0000 \Gamma&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.5000 0.0000 0.5000 X&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.5000 0.2500 0.7500 W&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.0000 0.0000 0.0000 \Gamma&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.5000 0.5000 0.5000 L&quot;</span><span class="p">),</span><span class="w"> </span><span class="mi">20</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">kpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">Line</span><span class="w"> </span><span class="n">Model</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="err">\</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="s">&quot;line&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">包含插点数的</span><span class="w"> </span><span class="n">K点</span><span class="p">,</span><span class="w"> </span><span class="n">参考QE</span>
<span class="w">                 </span><span class="s">&quot;0.0000 0.0000 0.0000 \Gamma 20&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.5000 0.0000 0.5000 X 20&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.5000 0.2500 0.7500 W 20&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.0000 0.0000 0.0000 \Gamma 1&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.5000 0.5000 0.5000 L 20&quot;</span><span class="p">)</span>
<span class="w"> </span><span class="cp"># 4. Reciprocal模式， 直接给出倒空间的全部 K点， 可参考IBZKPT</span>
<span class="w"> </span><span class="cp"># 如果不输入权值(第4个数字)，默认所有K点权重为 1 </span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">kpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Reciprocal&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span>\
<span class="w">                 </span><span class="s">&quot;0.0000 0.0000 0.0000 1&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.3333 0.0000 0.0000 6&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.3333 0.3333 0.0000 2&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.0000 0.0000 0.5000 1&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.3333 0.0000 0.5000 6&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;0.3333 0.3333 0.5000 2&quot;</span><span class="p">)</span>
<span class="w"> </span>
<span class="mf">10.</span><span class="w"> </span><span class="n">kpath</span>
<span class="w"> </span><span class="n">为特定任务独立设置K点</span><span class="err">，</span><span class="n">设置方法与上节相同</span><span class="err">，</span><span class="n">应用范围可以查看对应的任务</span><span class="err">。</span><span class="n">例如</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">kpath</span><span class="p">.</span><span class="n">band</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="n">Line</span><span class="w"> </span><span class="n">Model</span><span class="err">&#39;</span><span class="p">,(</span>\
<span class="w">                     </span><span class="s">&quot;0.0000 0.0000 0.0000 \Gamma&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;0.5000 0.0000 0.5000 X&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;0.5000 0.2500 0.7500 W&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;0.0000 0.0000 0.0000 \Gamma&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;0.5000 0.5000 0.5000 L&quot;</span><span class="p">),</span><span class="w"> </span><span class="mi">20</span>
<span class="w"> </span>
<span class="mf">11.</span><span class="w"> </span><span class="n">nbands</span>
<span class="w"> </span><span class="n">设置能带数或能带倍数</span><span class="err">，</span><span class="n">基准值来自自洽计算</span><span class="err">（</span><span class="n">SCF</span><span class="err">）。</span><span class="n">例如</span>
<span class="w"> </span><span class="cp"># 1. 直接设置nbands值</span>
<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">nbands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span>
<span class="w"> </span><span class="cp"># 2. 设置相对scf的倍数，最大为3（默认值为1.2）</span>
<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">bands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5</span>
<span class="w"> </span><span class="cp"># 在进行能带、光吸收等计算时，通常需要添加空带才能比较准确的计算导带的情况。</span>
<span class="w"> </span><span class="cp"># VASP的推荐值为1.2倍scf(能带计算)，QE为scf+4，请根据计算体系大小，设置合理的值。</span>
<span class="w"> </span><span class="cp"># 注意：该参数仅在电子结构计算和光学性质计算中有效</span>
<span class="w"> </span>
<span class="mf">12.</span><span class="w"> </span><span class="n">external_files</span>
<span class="w"> </span><span class="n">计算所需的额外文件</span><span class="err">。</span><span class="n">每次计算开始时</span><span class="err">，</span><span class="n">将自动地复制这些文件到计算目录中</span><span class="err">，</span><span class="n">如</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">external_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="o">~/</span><span class="p">.</span><span class="n">jamip</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="n">vdw_kernel</span><span class="p">.</span><span class="n">bindat</span><span class="err">&#39;</span>
<span class="w"> </span><span class="cp"># 如果需要复制多个路径，用逗号隔开即可，例如</span>
<span class="w"> </span><span class="n">vasp</span><span class="p">.</span><span class="n">external_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">&#39;</span><span class="o">~/</span><span class="p">.</span><span class="n">jamip</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="n">vdw_kernel</span><span class="p">.</span><span class="n">bindat</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">~/</span><span class="n">script</span><span class="o">/</span><span class="n">cbvb</span><span class="p">.</span><span class="n">x</span><span class="err">&#39;</span>
</pre></div>
</div>
</section>
<section id="input-py">
<h5>任务控制文件（input.py）中，用于文件准备的相关函数<a class="headerlink" href="#input-py" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">set_structure</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">output</span><span class="p">)</span> 
<span class="o">-</span> <span class="nb">input</span><span class="err">：</span><span class="n">输入结构文件目录</span>
<span class="o">-</span> <span class="n">output</span><span class="err">：</span><span class="n">输出计算文件目录</span>
<span class="o">&gt;</span> <span class="n">读取结构文件</span><span class="err">，</span><span class="n">生成任务池中的计算实例</span>
 
<span class="o">&gt;</span> <span class="n">set_extra</span><span class="p">()</span>
<span class="o">&gt;</span> <span class="n">根据结构生成</span><span class="o">.</span><span class="n">extra模板文件</span>
 
<span class="o">&gt;</span> <span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="o">-</span> <span class="n">path</span><span class="err">：</span><span class="n">任务池保存路径</span>
<span class="o">&gt;</span> <span class="n">保存任务池文件</span>
 
<span class="o">&gt;</span> <span class="n">Prepare</span><span class="o">.</span><span class="n">cluster</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
<span class="o">-</span> <span class="n">name</span><span class="err">：</span><span class="n">作业管理系统的名称</span><span class="err">，</span><span class="n">如</span><span class="err">`</span><span class="n">pbs</span><span class="err">`</span><span class="p">,</span><span class="err">`</span><span class="n">lsf</span><span class="err">`</span><span class="p">,</span><span class="err">`</span><span class="n">sbatch</span><span class="err">`</span>
<span class="o">&gt;</span> <span class="n">生成或检查集群参数文件</span><span class="err">`</span><span class="o">.</span><span class="n">cluster</span><span class="err">`</span>
 
<span class="o">&gt;</span> <span class="n">Prepare</span><span class="o">.</span><span class="n">incar</span><span class="p">(</span><span class="n">vasp</span><span class="p">)</span> 
<span class="o">-</span> <span class="n">vasp</span><span class="err">：</span><span class="n">VASP参数类</span>
<span class="o">&gt;</span> <span class="n">生成或检查计算参数文件</span><span class="err">`</span><span class="o">.</span><span class="n">incar</span><span class="err">`</span>

<span class="o">&gt;</span> <span class="n">Prepare</span><span class="o">.</span><span class="n">links</span><span class="p">(</span><span class="n">vasp</span><span class="p">)</span>
<span class="o">-</span> <span class="n">vasp</span><span class="err">：</span><span class="n">VASP参数类</span>
<span class="o">&gt;</span> <span class="n">生成任务关联文件</span><span class="err">`</span><span class="o">.</span><span class="n">link</span><span class="err">`</span>
</pre></div>
</div>
</section>
</section>
<section id="id6">
<h4>集群管理参数<a class="headerlink" href="#id6" title="Link to this heading"></a></h4>
<p>在JAMIP中，集群参数设置主要依靠<code class="docutils literal notranslate"><span class="pre">.cluster</span></code>文件，基于作业提交模板生成提交文件，并在计算节点上开展并行计算。
用户也可以在提交任务时通过命令行设置集群参数，详见 jp命令。例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jp</span> <span class="o">-</span><span class="n">r</span> <span class="n">qsub</span> <span class="o">-</span><span class="n">f</span> <span class="p">[</span><span class="n">pool</span><span class="p">]</span> <span class="o">--</span><span class="n">cores</span> <span class="mi">15</span> <span class="p">(</span><span class="n">使用15核进行计算</span><span class="p">)</span>
</pre></div>
</div>
<p>在任务提交后，用户仍可以修改<code class="docutils literal notranslate"><span class="pre">.cluster</span></code>文件，实现计算资源动态调控。参数修改将在下一个任务启动时生效。</p>
<section id="id7">
<h5>通用设置参数<a class="headerlink" href="#id7" title="Link to this heading"></a></h5>
<table border="1" class="docutils">
<thead>
<tr>
<th>属性</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>manager</td>
<td>集群的作业管理系统</td>
</tr>
<tr>
<td>job_name</td>
<td>设置任务名</td>
</tr>
<tr>
<td>queue</td>
<td>使用队列名</td>
</tr>
<tr>
<td>nodes</td>
<td>使用节点数</td>
</tr>
<tr>
<td>cores</td>
<td>单节点使用核数，适用于PBS系统</td>
</tr>
<tr>
<td>ntasks</td>
<td>总进程数，适用于LSF、SLURM系统</td>
</tr>
<tr>
<td>maximum</td>
<td>队列中的最大任务数</td>
</tr>
<tr>
<td>walltime</td>
<td>任务最大运行时间</td>
</tr>
<tr>
<td>cmd</td>
<td>提交任务使用的命令</td>
</tr>
<tr>
<td>mpi</td>
<td>并行计算程序使用的并行命令</td>
</tr>
<tr>
<td>env</td>
<td>用于声明环境变量，如：编译器和python等</td>
</tr>
<tr>
<td>user</td>
<td>提交任务的用户名，自动生成</td>
</tr>
<tr>
<td>host</td>
<td>提交任务所在的主机，自动生成</td>
</tr>
</tbody>
</table></section>
<section id="id8">
<h5>作业提交模板<a class="headerlink" href="#id8" title="Link to this heading"></a></h5>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#PBS -N {{ job_name }}</span>
<span class="c1">#PBS -q {{ queue }}</span>
<span class="c1">#PBS -l nodes={{ nodes }}:ppn={{ cores }}</span>
<span class="c1">#PBS -l walltime={{ walltime }}</span>
<span class="c1">#PBS -o {{ output }}</span>
<span class="c1">#PBS -e .error</span>

<span class="nb">cd</span><span class="w"> </span><span class="nv">$PBS_O_WORKDIR</span>

<span class="o">{</span>%<span class="w"> </span><span class="k">for</span><span class="w"> </span>line<span class="w"> </span><span class="k">in</span><span class="w"> </span>env<span class="w"> </span>%<span class="o">}</span>
<span class="o">{{</span><span class="w"> </span>line<span class="w"> </span><span class="o">}}</span>
<span class="o">{</span>%<span class="w"> </span>endfor<span class="w"> </span>%<span class="o">}</span>

python3<span class="w"> </span><span class="o">{{</span><span class="w"> </span>script<span class="w"> </span><span class="o">}}</span><span class="w"> </span><span class="o">{{</span><span class="w"> </span>root<span class="w"> </span><span class="o">}}</span><span class="w"> </span><span class="o">{{</span><span class="w"> </span>outdir<span class="w"> </span><span class="o">}}</span><span class="w"> </span><span class="o">{{</span><span class="w"> </span>pool<span class="w"> </span><span class="o">}}</span><span class="w"> </span>&gt;<span class="w"> </span>.running
</pre></div>
</div>
<p>作业提交模板基于Jinja2语言，可以注意到模板中的变量名大部分与前面的参数字典对应。<br />在JAMIP提交任务时，将从本地配置文件<code class="docutils literal notranslate"><span class="pre">.cluster</span></code>中读取集群参数，同任务信息一起传递到模板文件，在任务计算目录生成提交脚本<code class="docutils literal notranslate"><span class="pre">submit.sh</span></code>并提交。
如果用户希望自定义作业提交模板，可以参考 <a class="reference external" href="https://jinja.palletsprojects.com/">Jinja2</a> 修改模板文件及集群参数文件，注意确保两者变量名称一致。</p>
<p><strong>mpi并行命令与核数：</strong><br />如果并行命令为<code class="docutils literal notranslate"><span class="pre">mpirun</span></code>，JAMIP将补足为 <code class="docutils literal notranslate"><span class="pre">mpirun</span> <span class="pre">-np</span> <span class="pre">&lt;sum_cores&gt;</span></code><br />对于其他并行命令(例如<code class="docutils literal notranslate"><span class="pre">srun</span></code>)，JAMIP默认作业管理系统会自动完成并行进程管理，不需要补充参数<br />关于上述总核数的获取，由于不同作业管理系统存在差异，JAMIP将优先使用<code class="docutils literal notranslate"><span class="pre">ntasks</span></code> (lsf, slurm)，如不存在则使用<code class="docutils literal notranslate"><span class="pre">nodes*cores</span></code> (pbs)</p>
</section>
</section>
</section>
<section id="id9">
<h3>4.1.2 任务池管理与批量提交<a class="headerlink" href="#id9" title="Link to this heading"></a></h3>
<p><img alt="png" src="https://note.youdao.com/yws/api/personal/file/C9B9A8C7498B49B6988562A856B46206?method=download&amp;shareKey=41d2eb86e652910a2dbf6c91fdda4ce9" /></p>
<section id="id10">
<h4>任务池文件说明<a class="headerlink" href="#id10" title="Link to this heading"></a></h4>
<p>任务池由任务计算数据和任务状态信息两部分组成。其中，任务计算数据一般为<code class="docutils literal notranslate"><span class="pre">xxx.dat</span></code>文件，保存序列化的计算类，包含任务的计算内容、计算参数和结构信息。任务状态信息以dbm数据库的形式保存，命名为<code class="docutils literal notranslate"><span class="pre">.xxx.dat.dat</span></code>等。数据库中保存了任务的计算目录、状态和优先级，提交任务时将按照优先级顺序，依次提交任务池中状态为等待(W)的任务，并将其状态更新为运行(R)。当任务计算完成后，JAMIP将再次调用任务管理模块，将该任务状态更新为完成(C)。</p>
</section>
<section id="id11">
<h4>再次提交<a class="headerlink" href="#id11" title="Link to this heading"></a></h4>
<p>由于JAMIP提交任务时仅提交状态为W的任务，如果用户希望重新提交之前计算过的任务，需要刷新任务池状态，以下是两种可选方式：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1. jp -r prepare  重新生成任务池
2. jp -c prepare -f &lt;任务池&gt;  根据各计算目录的状态信息，更新任务池文件
</pre></div>
</div>
<p>如果用户遇到大批量计算中有少数任务计算失败的情况(例如结构优化步数不够)，建议使用第二种方式提交，减少对队列的占用。</p>
</section>
<section id="id12">
<h4>多任务池与排队机制<a class="headerlink" href="#id12" title="Link to this heading"></a></h4>
<p>在<code class="docutils literal notranslate"><span class="pre">.cluster</span></code>中的<code class="docutils literal notranslate"><span class="pre">maximum</span></code>参数设置了JAMIP从当前任务池提交到队列的最大任务数。当执行<code class="docutils literal notranslate"><span class="pre">jp</span> <span class="pre">-r</span> <span class="pre">qsub</span> <span class="pre">-f</span> <span class="pre">&lt;poolfile&gt;</span></code>时，如果任务池中待提交任务数充足，将提交<code class="docutils literal notranslate"><span class="pre">maximum</span></code>个任务到计算队列。当队列中JAMIP任务计算完成时，将从任务池中提交n个新任务，维持队列中正在计算和等待计算的任务总数为<code class="docutils literal notranslate"><span class="pre">maximum</span></code>。</p>
<p>对于JAMIP提交任务与非JAMIP任务、其他JAMIP任务池任务的计算优先级，通过<code class="docutils literal notranslate"><span class="pre">.cluster</span></code>中的<code class="docutils literal notranslate"><span class="pre">resubmit</span></code>参数设置，系统默认为<code class="docutils literal notranslate"><span class="pre">prior</span></code></p>
<ul class="simple">
<li><p>prior: 保证队列中JAMIP任务数等于maximum，即优先完成当前任务池</p></li>
<li><p>mini: 保证队列中JAMIP任务数不少于1的同时，使总任务数等于maximum，即优先完成队列中的其他任务</p></li>
</ul>
<p>用户同时提交的多个任务池，将按提交至队列的先后顺序计算，任务池之间不会相互影响。</p>
<p>请注意，部分集群会限制用户最大提交的任务数。如果用户需要同时提交多个任务池，需要适当减少每个任务池的<code class="docutils literal notranslate"><span class="pre">maximum</span></code>。
<code class="docutils literal notranslate"><span class="pre">.cluster</span></code>仅在任务提交和计算开始时读取，用户可以通过修改<code class="docutils literal notranslate"><span class="pre">.cluster</span></code>的内容调整后续计算资源。例如将<code class="docutils literal notranslate"><span class="pre">maximum</span></code>参数修改为0，JAMIP将不会为当前任务池提交新的任务。</p>
</section>
<section id="id13">
<h4>子任务池<a class="headerlink" href="#id13" title="Link to this heading"></a></h4>
<p>在部分JAMIP计算中，例如力常数、形变势等计算流程需要完成大量并行的计算任务，在单个计算节点可能需要较长时间。JAMIP支持为这些计算流程创建小型任务池，同时使用多个计算节点计算以加速计算流程。用户可以在支持并行计算的任务参数字典中设置<code class="docutils literal notranslate"><span class="pre">parallel</span></code>参数来开启该功能。<code class="docutils literal notranslate"><span class="pre">parallel</span></code>为最大并行数，若设置<code class="docutils literal notranslate"><span class="pre">parallel=1</span></code>或仅有一个任务需要计算，子任务仍将在当前计算节点上进行。</p>
<p>需要注意，子任务池不受上文中最大任务数<code class="docutils literal notranslate"><span class="pre">maximum</span></code>的限制，用户需要平衡设置<code class="docutils literal notranslate"><span class="pre">maximum</span></code>与<code class="docutils literal notranslate"><span class="pre">parallel</span></code>，避免子任务数爆炸。</p>
<p>当子任务全部计算完成后，完成最后子任务计算的计算节点将继续余下部分任务流程的计算。为了避免子流程和主流程的冲突(死循环)，我们设置主流程不会对当前子流程进行计算，同时删除任务池文件。</p>
</section>
</section>
<section id="id14">
<h3>4.1.3 任务执行流程<a class="headerlink" href="#id14" title="Link to this heading"></a></h3>
<p>本节将介绍在计算节点上，DFT程序的一般运行流程。</p>
<p><img alt="png" src="https://note.youdao.com/yws/api/personal/file/B6B0B7B3E59F4B1D995DEEB16E1F498C?method=download&amp;shareKey=be7d8b14e9626e8030459461ccaa8493" /></p>
<p><strong>1. 任务依赖</strong></p>
<p>在进行计算任务时，我们往往会按照一定的计算顺序，如结构优化 -&gt; 自洽 -&gt; 性质计算
在JAMIP中，我们使用字典来记录这种任务间的依赖关系，保存在<code class="docutils literal notranslate"><span class="pre">.link</span></code>文件中。例如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">relax</span><span class="p">:</span> <span class="p">[]</span>
<span class="n">scf</span><span class="p">:</span>
<span class="o">-</span>  <span class="n">relax</span>
<span class="n">band</span><span class="p">:</span>
<span class="o">-</span>  <span class="n">scf</span>
<span class="n">hse_gap</span><span class="p">:</span>
<span class="o">-</span>  <span class="n">scf</span>
<span class="o">-</span>  <span class="n">band</span>
</pre></div>
</div>
<p>在上面的示例文件中，relax无依赖，scf依赖relax，band依赖scf。对于hse_gap这种多个依赖的任务，一般是第一个依赖项提供电荷波函数结构文件(scf)，最后一个提供其他性质或文件(band提供带边位置)。用户可以通过修改<code class="docutils literal notranslate"><span class="pre">.link</span></code>文件修改计算任务间的依赖关系，例如希望hse_gap的带边信息从scf计算中获取，可以设置为</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hse_gap</span><span class="p">:</span> 
<span class="o">-</span>  <span class="n">scf</span>
</pre></div>
</div>
<p>JAMIP内部设置了稳健的任务依赖关系，因此用户通常不需要修改<code class="docutils literal notranslate"><span class="pre">.link</span></code>文件，用户可以查看<code class="docutils literal notranslate"><span class="pre">.link</span></code>获取并修改任务依赖。<br />需要注意，与其他配置文件不同，<code class="docutils literal notranslate"><span class="pre">.link</span></code>会在每次<code class="docutils literal notranslate"><span class="pre">jp</span> <span class="pre">-r</span> <span class="pre">prepare</span></code>后重新生成，文件中的任务及依赖项必须全部包含在input.py的vasp.tasks中。</p>
<p><strong>2. 任务执行顺序</strong></p>
<p>在JAMIP内部，任务会被标记为以下几种状态</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>简写</th>
<th>W</th>
<th>H</th>
<th>R</th>
<th>C</th>
<th>E</th>
<th>D</th>
</tr>
</thead>
<tbody>
<tr>
<td>状态</td>
<td>等待</td>
<td>挂起</td>
<td>运行</td>
<td>完成</td>
<td>失败</td>
<td>纠错中</td>
</tr>
</tbody>
</table><p>在全部计算开始前，JAMIP将从当前计算目录的<code class="docutils literal notranslate"><span class="pre">.status</span></code>获取目前任务完成状态，将完成的任务状态设置为C，未完成的设置为W，再将有依赖任务未完成的任务设置为H。对于全部等待的任务，将按用户在vasp.tasks中的输入顺序进行计算。当一个任务完成后，如果任务正确计算，JAMIP会将任务状态设置为C，递归的更新依赖该任务的状态，否则将任务状态设置为E。如果任务在计算过程中被纠错流程重新计算，JAMIP会将其任务状态设置为D，以避免纠错陷入死循环。
JAMIP通过<code class="docutils literal notranslate"><span class="pre">.status</span></code>文件唯一的判断计算任务是否完成。如果用户希望重新计算某些已被标记为完成的任务，可以在input.py内设置overwrite参数。例如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vasp</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="s1">&#39;scf band&#39;</span>
</pre></div>
</div>
<p>JAMIP将不会读取这些任务的完成状态，强制其重新计算</p>
<p><strong>3，文件继承</strong></p>
<p>在第一性原理计算时，通常需要拷贝之前自洽计算获得的结构、电荷密度、波函数文件进行性质计算。出于计算效率的考虑，如果用户没有在计算参数中设置<code class="docutils literal notranslate"><span class="pre">ICHARG</span></code>和<code class="docutils literal notranslate"><span class="pre">IWAVE</span></code>，JAMIP将使用VASP的默认值，即尽可能继承之前计算的CHGCAR和WAVECAR。
在生成计算输入文件时，可能存在以下情况：</p>
<ul class="simple">
<li><p>当前计算明确不需要电荷密度/波函数，不复制这些文件</p></li>
<li><p>依赖计算中存在电荷密度/波函数，且当前计算也会输出这些文件，复制文件</p></li>
<li><p>依赖计算中存在电荷密度/波函数，且当前计算不会输出这些文件，复制文件的软链接</p></li>
<li><p>依赖计算中不存在电荷密度/波函数，当前计算可以不需要该文件，修改计算参数</p></li>
<li><p>依赖计算中不存在电荷密度/波函数，且当前计算明确需要该文件，计算失败</p></li>
</ul>
<p>QE程序：
在进行结构优化时，输出目录均为： <code class="docutils literal notranslate"><span class="pre">qesave/relax.save</span></code>，QE程序将自动继承上一步的计算输出信息。同时，程序会基于xml文件来更新内存中的结构数据。
自洽场计算的输出目录为： <code class="docutils literal notranslate"><span class="pre">qesave/scf.save</span></code>，默认将不继承结构优化计算的波函数和电荷密度。
在进行性质计算时，JAMIP将复制 <code class="docutils literal notranslate"><span class="pre">qesave/scf.save</span></code> 目录下的文件到本次计算目录下，作为计算的初始信息，即默认将继承上步（SCF）输出的电荷密度与波函数</p>
<p><strong>4. 单任务流程</strong>
<img alt="png" src="https://note.youdao.com/yws/api/personal/file/WEBd333fa173e0452b8ee1f3edc819dba89?method=download&amp;shareKey=c3cf9e8717a2ab226b54ee43e86cbb90" /></p>
<p><strong>5. 计算参数更新</strong></p>
<p>在自动生成计算任务参数时，JAMIP将按照以下顺序进行设置：</p>
<ul class="simple">
<li><p>从任务类加载参数字典 (.incar中的base字典+对应任务字典)</p></li>
<li><p>添加任务流程所需参数，如：设置 nbands, iband 等</p></li>
<li><p>更新组参数，如hse、gw、ldau、soc等</p></li>
<li><p>更新涉及输入文件的参数，如： encut, kspacing, istart 等</p></li>
</ul>
<p>备注： 在计算程序开始时，JAMIP会将 input.py 中设置的收敛参数加入到 base 的字典中。</p>
</section>
<section id="id15">
<h3>4.1.4 任务监控与纠错<a class="headerlink" href="#id15" title="Link to this heading"></a></h3>
<p>VASP程序在运行过程中，可能由于参数设置不合理、文件准备不足等原因，计算任务会异常中断。
目前，JAMIP提供了VASP计算任务的纠错功能，能够根据JAMIP的输出日志内的错误信息，自动尝试调整计算参数等方案，纠正异常的计算任务。用户可以选择是否开启纠错功能，并且可以自由增添、修改错误集的内容。针对QE计算任务的纠错解决方案集正在更新中。</p>
<section id="id16">
<h4>监控模块<a class="headerlink" href="#id16" title="Link to this heading"></a></h4>
<p>监控模块是计算流程中任务提交函数的一个装饰器，用户可以通过屏蔽该装饰器来关闭该监控功能
<strong>代码链接-装饰器</strong>： abtools/vasp/vaspflow.py
<strong>代码链接-监控模块</strong>： abtools/vasp/monitor.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="nd">@Monitor</span>
 <span class="k">def</span> <span class="nf">mpirun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incar</span><span class="p">,</span> <span class="n">stdout</span><span class="p">):</span>
     <span class="o">...</span>
</pre></div>
</div>
<p>在计算过程中，JAMIP会创建子线程执行VASP程序，而主线程负责监控任务运行。
程序会定期读取VASP程序的输出日志，检查文件中出现的错误关键词。正常情况下，子线程将在VASP计算完成后退出，主线程的监控器将在子线程停止活动后退出。当监控器发现错误时，将向并行计算程序（mpi）发出退出信号，子线程和监控器将依次退出，主线程将根据监控器返回的error属性，更新参数字典并进行纠错计算。
由于纠错计算中程序也会启动监控模块，为避免程序进入死循环，每个任务最多执行一次纠错计算，纠错时进行的参数修改对本次计算全局有效。</p>
</section>
<section id="id17">
<h4>集群检查<a class="headerlink" href="#id17" title="Link to this heading"></a></h4>
<p>在计算程序启动前，JAMIP将检查计算节点的状态，确保高通量计算能够连续正常地进行
警告类：</p>
<ol class="simple">
<li><p>CPU核数是否与并行设置相符</p></li>
<li><p>当前CPU占用是否超过90%</p></li>
<li><p>当前内存占用是否超过90%</p></li>
<li><p>节点上是否存在正在运行的并行程序</p></li>
</ol>
<p>退出类： 如果集群上存在VASP孤儿进程，将向这些进程发出退出信号</p>
</section>
<section id="id18">
<h4>纠错计算和纠错集设置<a class="headerlink" href="#id18" title="Link to this heading"></a></h4>
<p>JAMIP将常用的纠错方案储存在 <code class="docutils literal notranslate"><span class="pre">~/.jamip/env/error.yaml</span></code>，每个纠错方案包含纠错名称、错误关键词和纠错参数。
用户可以根据自身需要，自由的添加和修改纠错集。以下是文件示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NPAR</span><span class="p">:</span>
<span class="o">-</span>  <span class="n">Please</span> <span class="n">remove</span> <span class="n">the</span> <span class="n">tag</span> <span class="n">NPAR</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">INCAR</span>
<span class="o">-</span>  <span class="n">npar</span><span class="p">:</span> 
<span class="n">NCL</span><span class="p">:</span>
<span class="o">-</span>  <span class="n">non</span> <span class="n">collinear</span> <span class="n">calculations</span> <span class="n">require</span> <span class="n">that</span> <span class="n">VASP</span> <span class="ow">is</span> <span class="n">compiled</span>
<span class="o">-</span> 
<span class="n">EDIFF</span>
<span class="o">-</span>  <span class="n">please</span> <span class="n">rerun</span> <span class="k">with</span> <span class="n">smaller</span> <span class="n">EDIFF</span>
<span class="o">-</span>  <span class="n">ediff</span><span class="p">:</span> <span class="n">ediff</span> <span class="o">*</span> <span class="mf">0.1</span>
</pre></div>
</div>
<p>其中，NPAR纠错需要在INCAR中移除NPAR参数，因此设置纠错方案为<code class="docutils literal notranslate"><span class="pre">NPAR=None</span></code>，JAMIP将不再输出该参数。
NCL纠错需要使用<code class="docutils literal notranslate"><span class="pre">vasp_ncl</span></code>进行计算，需要通过修改<code class="docutils literal notranslate"><span class="pre">input.py</span></code>解决，无法自动解决，因此设置解决方案为空，此时将不再进行纠错，直接跳过该任务。
如果纠错方案中包含计算符，例如上面的第三个例子，JAMIP将自动查询并替换其中的字母部分。例如当前计算的EDIFF等于0.001，纠错后EDIFF将等于0.0001 。</p>
</section>
</section>
<section id="id19">
<h3>4.1.5 计算结果提取与分析<a class="headerlink" href="#id19" title="Link to this heading"></a></h3>
<p>使用jp命令可以实现简单的数据提取功能。目前，JAMIP支持批量提取计算数据/计算参数
（复杂或特定的数据提取活动，需要用户编写脚本）
<strong>jp -o –output [输出格式] [输出性质] -f [计算目录/任务池]</strong></p>
<ul class="simple">
<li><p><strong>输出格式：</strong> <code class="docutils literal notranslate"><span class="pre">form</span> <span class="pre">sort</span> <span class="pre">csv</span> <span class="pre">plot</span></code></p></li>
<li><p><strong>输出性质：</strong> Finder模块的单返回值方法和部分计算性质</p></li>
</ul>
<p><strong>1. 路径输入判断</strong>
通过<code class="docutils literal notranslate"><span class="pre">.status</span></code>（针对JAMIP）和<code class="docutils literal notranslate"><span class="pre">OUTCAR</span></code>（一般VASP计算）来判断输入目录是否为计算目录。
如果输入目录不是计算目录，将继续判断输入目录的子目录是否为计算目录。
如果未给程序指定任何目录，将使用当前目录作为输入值。</p>
<p><strong>2. 输出格式说明</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>I. csv格式说明：
生成以逗号为分隔符的csv文件，保存标签；路径保存到最后一级
对于出现无法正确读取数据的情况，程序将使用np.nan来进行补足
 
$ jp -o csv free_energy -f TEST
 
$ cat TEST.csv
path,free_energy
Si2.vasp,-43.40082825
Si.vasp,-43.40082825
II. sort格式说明：
适用于少量数据的处理，根据所选属性的值对计算目录进行排列操作
 
$ jp -o sort emass -f TEST
+------------------+
| Property: e-mass |
+------------------+
POSCAR2, 0.287
POSCAR, 0.224
+------------------+
| Property: H-mass |
+------------------+
POSCAR2, 1.005
POSCAR, 1.145
III. form格式说明
以表格形式输出属性值，方便用户直观地查看数据
当jp -o命令未选择输出格式时，以此格式输出
请适量控制输出属性的个数，以确保输出表格长度在单行字数限制以内，提高输出样式的可读性
 
$ jp -o emass -f TEST 
+---------+--------+--------+ 
|  path   | e-mass | H-mass | 
+---------+--------+--------+ 
| POSCAR2 | 0.287  | 1.005  | 
| POSCAR  | 0.224  | 1.145  | 
+---------+--------+--------+ 
IV. plot格式说明
对数据进行快速地分布统计/关联性分析，适用于处理大量数据
</pre></div>
</div>
<p><strong>3. 支持输出性质</strong></p>
<table border="1" class="docutils">
<thead>
<tr>
<th>计算性质</th>
<th>数据输出</th>
</tr>
</thead>
<tbody>
<tr>
<td>format</td>
<td>化学式(format)</td>
</tr>
<tr>
<td>work_function</td>
<td>功函数(work_function) （注：需要VASP计算真空能级且真空层在z方向）</td>
</tr>
<tr>
<td>bandgap</td>
<td>带隙值(bandgap)，是否为直接带隙(isdirect)</td>
</tr>
<tr>
<td>emass</td>
<td>空穴有效质量(H-mass)，电子有效质量(e-mass)（注：有效质量为取几何平均获得平均值）</td>
</tr>
<tr>
<td>dielectric</td>
<td>电子部分的介电常数(dielectric)，离子部分的介电常数(dielectric-ion)</td>
</tr>
<tr>
<td>cbvb</td>
<td>带隙(bandgap)，价带顶(vbm-kpoint)，导带顶(cbm-kpoint)</td>
</tr>
<tr>
<td>boltztrap</td>
<td>空穴有效质量(H-mass)，电子有效质量(e-mass)（注：调用boltztrap程序的计算结果）</td>
</tr>
</tbody>
</table><table border="1" class="docutils">
<thead>
<tr>
<th>数据类型</th>
<th>计算参数</th>
</tr>
</thead>
<tbody>
<tr>
<td>int</td>
<td>nkdim, nedos, nbands, nkpts, istart, icharg, ispin, nelm, nsw, nfree</td>
</tr>
<tr>
<td></td>
<td>lmaxmix ,ibrion, isif, isym, pstress, nelect, ismear, ialgo, lorbit</td>
</tr>
<tr>
<td>float</td>
<td>encut, ediff, ediffg, cshift, potim, emin, emax, sigma,volume</td>
</tr>
<tr>
<td></td>
<td>free_energy,energy_without_entropy,fermi_energy,max_force</td>
</tr>
<tr>
<td>str</td>
<td>prec, gga, point_group, datetime,vasp_version,date</td>
</tr>
<tr>
<td>bool</td>
<td>lsorbit, lwave, lcharg, lvtot, lelf</td>
</tr>
</tbody>
</table></section>
<section id="id20">
<h3>4.1.6 计算结果存储<a class="headerlink" href="#id20" title="Link to this heading"></a></h3>
<p>用户可参阅上一章节，将计算结果储存到csv文件或数据库中。</p>
<p><strong>数据存储命令：</strong>
<strong>jp -o csv free_energy fermi_energy … -f [path]</strong> 批量导出为csv文件
<strong>jp –db entry -f [path]</strong> 批量存储计算结果
<strong>jp –db structure -f [path]</strong> 批量存储结构文件
当未指定存储路径时，将使用当前目录作为输入目录</p>
<p><strong>数据存储函数：</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jamip.db.connect</span> <span class="kn">import</span> <span class="n">Connect</span> <span class="c1">#初始化django连接</span>
<span class="kn">import</span> <span class="nn">os</span>
 
<span class="c1"># 将计算数据存储到数据库中</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">Connect</span><span class="p">()</span> <span class="c1"># 实例化类</span>
<span class="n">properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;calculated_parameters&#39;</span><span class="p">,</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span><span class="s1">&#39;bandgap&#39;</span><span class="p">,</span><span class="s1">&#39;boltztrap&#39;</span><span class="p">,</span>
 <span class="s1">&#39;born_effective_charge&#39;</span><span class="p">]</span> 
<span class="n">db</span><span class="o">.</span><span class="n">load_entry</span><span class="p">(</span><span class="s1">&#39;TEST/Si.vasp&#39;</span><span class="p">,</span><span class="n">properties</span><span class="p">)</span> <span class="c1"># 保存Si.vasp目录下的计算数据</span>
<span class="c1"># 输入路径可以是：任务池、计算根目录或计算父目录(包含多个根目录)</span>
 
<span class="c1"># 将结构文件存储到数据库中</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">Connect</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">load_structure</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="c1"># 保存文件夹内的全部结构文件</span>
<span class="c1"># 通过文件名判断是否为结构文件及其数据类型，请确保文件名的合理命名。</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kun Zhou.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>